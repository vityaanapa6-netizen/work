const express = require('express');
const TelegramBot = require('node-telegram-bot-api');
const cors = require('cors');

// --- –í–ê–®–ò –°–ï–ö–†–ï–¢–ù–´–ï –î–ê–ù–ù–´–ï ---
// –í–ê–ñ–ù–û: –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ —Å–≤–æ–∏ —Ä–µ–∞–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω –∏ ID —á–∞—Ç–∞
const TELEGRAM_BOT_TOKEN = '–í–ê–®_–¢–ï–õ–ï–ì–†–ê–ú_–¢–û–ö–ï–ù_–ë–û–¢–ê';
const TELEGRAM_CHAT_ID = '–í–ê–®_ID_–¢–ï–õ–ï–ì–†–ê–ú_–ß–ê–¢–ê';
// -----------------------------

const app = express();
const port = 3000;

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–æ–∫–µ–Ω –∏ ID —á–∞—Ç–∞ –≤–≤–µ–¥–µ–Ω—ã
if (TELEGRAM_BOT_TOKEN === '–í–ê–®_–¢–ï–õ–ï–ì–†–ê–ú_–¢–û–ö–ï–ù_–ë–û–¢–ê' || TELEGRAM_CHAT_ID === '–í–ê–®_ID_–¢–ï–õ–ï–ì–†–ê–ú_–ß–ê–¢–ê') {
    console.error("\x1b[41m%s\x1b[0m", "–û–®–ò–ë–ö–ê: –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –∏ ID —á–∞—Ç–∞ –≤ —Ñ–∞–π–ª–µ server.js");
    process.exit(1); // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –≤–≤–µ–¥–µ–Ω—ã
}

const bot = new TelegramBot(TELEGRAM_BOT_TOKEN);

// Middlewares
app.use(cors()); // –†–∞–∑—Ä–µ—à–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã —Å –¥—Ä—É–≥–∏—Ö –¥–æ–º–µ–Ω–æ–≤ (—Å –≤–∞—à–µ–≥–æ frontend)
app.use(express.json()); // –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–∞—Ä—Å–∏—Ç—å JSON –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞

// –†–æ—É—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≤—ã–≤–æ–¥
app.post('/withdraw', (req, res) => {
    const { amount } = req.body;

    if (!amount || isNaN(amount)) {
        return res.status(400).json({ error: '–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞' });
    }

    console.log(`–ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–≤–æ–¥: ${amount} –≥—Ä–Ω`);

    const message = `
    üö® *–ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–≤–æ–¥!* üö®
    -----------------------------
    üí∞ *–°—É–º–º–∞:* ${amount} –≥—Ä–Ω
    -----------------------------
    üïí *–í—Ä–µ–º—è:* ${new Date().toLocaleString('uk-UA')}
    `;

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
    bot.sendMessage(TELEGRAM_CHAT_ID, message, { parse_mode: 'Markdown' })
        .then(() => {
            console.log('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.');
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–ª–∏–µ–Ω—Ç—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
            res.status(200).json({ success: true, message: '–ó–∞–ø—Ä–æ—Å –ø—Ä–∏–Ω—è—Ç' });
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram:', error.code, error.response.body);
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–ª–∏–µ–Ω—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–µ
            res.status(500).json({ success: false, message: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        });
});

// –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä
app.listen(port, () => {
    console.log(`–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –∏ —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç http://localhost:${port}`);
    console.log("\x1b[32m%s\x1b[0m", "–°–µ—Ä–≤–µ—Ä –≥–æ—Ç–æ–≤ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –æ—Ç –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —á–∞—Å—Ç–∏.");
});
